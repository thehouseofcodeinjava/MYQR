<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced QR Code Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .input-section, .preview-section {
      flex: 1;
      min-width: 300px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #qr-preview {
      text-align: center;
      position: relative;
    }
    canvas {
      max-width: 100%;
    }
    .draggable {
      position: absolute;
      cursor: move;
      user-select: none;
    }
    @media (max-width: 600px) {
      .container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <h1>Advanced QR Code Generator</h1>
  <div class="container">
    <div class="input-section">
      <label for="content">Content</label>
      <input type="text" id="content" oninput="generateQR()" placeholder="Enter URL or text">

      <label for="fg-color">Foreground Color</label>
      <input type="color" id="fg-color" value="#000000" onchange="generateQR()">

      <label for="bg-color">Background Color</label>
      <input type="color" id="bg-color" value="#ffffff" onchange="generateQR()">

      <label for="bg-image">Background Image</label>
      <input type="file" id="bg-image" accept="image/*" onchange="generateQR()">

      <label for="shape">QR Code Shape</label>
      <select id="shape" onchange="generateQR()">
        <option value="square">Square</option>
        <option value="circle">Circle</option>
        <option value="hexagon">Hexagon</option>
        <option value="rounded">Rounded</option>
        <option value="triangle">Triangle</option>
      </select>

      <label for="logo">Upload Logo</label>
      <input type="file" id="logo" accept="image/*" onchange="generateQR()">
      <button onclick="removeLogo()">Remove Logo</button>

      <label for="text-overlay">Text Overlay</label>
      <input type="text" id="text-overlay" oninput="generateQR()" placeholder="Enter overlay text">

      <label for="format">Download Format</label>
      <select id="format">
        <option value="png">PNG</option>
        <option value="svg">SVG</option>
      </select>

      <button onclick="downloadQR()">Download QR Code</button>
    </div>

    <div class="preview-section">
      <h3>Preview</h3>
      <div id="qr-preview"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    let logoImg, textDiv;

    function generateQR() {
      const content = document.getElementById('content').value;
      const fg = document.getElementById('fg-color').value;
      const bg = document.getElementById('bg-color').value;
      const shape = document.getElementById('shape').value;
      const logoFile = document.getElementById('logo').files[0];
      const text = document.getElementById('text-overlay').value;
      const bgImageFile = document.getElementById('bg-image').files[0];
      const preview = document.getElementById('qr-preview');

      preview.innerHTML = '';
      const canvas = document.createElement('canvas');
      canvas.id = 'qr-canvas';
      canvas.width = 300;
      canvas.height = 300;
      preview.appendChild(canvas);

      QRCode.toCanvas(canvas, content, {
        width: 300,
        color: {
          dark: fg,
          light: bg
        },
        errorCorrectionLevel: 'H'
      }, async (err) => {
        if (err) return console.error(err);

        const ctx = canvas.getContext('2d');

        // Apply background image
        if (bgImageFile) {
          const bgImg = new Image();
          bgImg.src = URL.createObjectURL(bgImageFile);
          await bgImg.decode();
          ctx.globalCompositeOperation = 'destination-over';
          ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
        }

        // Apply shape
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        const r = canvas.width / 2;
        if (shape === 'circle') {
          ctx.arc(r, r, r, 0, Math.PI * 2);
        } else if (shape === 'hexagon') {
          for (let i = 0; i < 6; i++) {
            const angle = (Math.PI / 3) * i;
            const x = r + r * Math.cos(angle);
            const y = r + r * Math.sin(angle);
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
          }
        } else if (shape === 'triangle') {
          ctx.moveTo(r, 0);
          ctx.lineTo(0, canvas.height);
          ctx.lineTo(canvas.width, canvas.height);
        } else if (shape === 'rounded') {
          ctx.arc(r, r, r, 0, Math.PI * 2);
        } else {
          ctx.rect(0, 0, canvas.width, canvas.height);
        }
        ctx.closePath();
        ctx.clip();
        ctx.putImageData(imageData, 0, 0);

        // Add logo
        if (logoFile) {
          const img = new Image();
          img.src = URL.createObjectURL(logoFile);
          await img.decode();
          logoImg = document.createElement('img');
          logoImg.src = img.src;
          logoImg.classList.add('draggable');
          logoImg.style.top = '40%';
          logoImg.style.left = '40%';
          logoImg.style.width = '60px';
          logoImg.style.height = '60px';
          preview.appendChild(logoImg);
          makeDraggable(logoImg);
        }

        // Add text overlay
        if (text) {
          textDiv = document.createElement('div');
          textDiv.innerText = text;
          textDiv.classList.add('draggable');
          textDiv.style.top = '85%';
          textDiv.style.left = '50%';
          textDiv.style.transform = 'translateX(-50%)';
          textDiv.style.font = '20px Arial';
          preview.appendChild(textDiv);
          makeDraggable(textDiv);
        }
      });
    }

    function makeDraggable(el) {
      let offsetX, offsetY;
      el.onmousedown = function(e) {
        offsetX = e.clientX - el.offsetLeft;
        offsetY = e.clientY - el.offsetTop;
        document.onmousemove = function(e) {
          el.style.left = e.clientX - offsetX + 'px';
          el.style.top = e.clientY - offsetY + 'px';
        };
        document.onmouseup = function() {
          document.onmousemove = null;
          document.onmouseup = null;
        };
      };
    }

    function removeLogo() {
      if (logoImg && logoImg.parentNode) {
        logoImg.parentNode.removeChild(logoImg);
        logoImg = null;
      }
    }

    function downloadQR() {
      const format = document.getElementById('format').value;
      const canvas = document.getElementById('qr-canvas');
      if (!canvas) return alert('Generate the QR code first');

      if (format === 'png') {
        html2canvas(document.getElementById('qr-preview')).then(canvas => {
          const link = document.createElement('a');
          link.download = 'qr-code.png';
          link.href = canvas.toDataURL();
          link.click();
        });
      } else if (format === 'svg') {
        const content = document.getElementById('content').value;
        QRCode.toString(content, { type: 'svg' }, (err, svg) => {
          if (err) return console.error(err);
          const blob = new Blob([svg], { type: 'image/svg+xml' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'qr-code.svg';
          link.click();
        });
      }
    }
  </script>
</body>
</html>
